package auth

import (
	"fmt"
	"net/url"
	"strings"
)

func ValidateRedirectURL(redirectURL string, allowedURLs []string) error {
	if redirectURL == "" {
		return fmt.Errorf("redirect URL is empty")
	}

	if len(allowedURLs) == 0 {
		return fmt.Errorf("no allowed redirect URLs configured")
	}

	parsedRedirect, err := url.Parse(redirectURL)
	if err != nil {
		return fmt.Errorf("invalid redirect URL format: %w", err)
	}

	if parsedRedirect.Scheme != "http" && parsedRedirect.Scheme != "https" {
		return fmt.Errorf("invalid redirect URL scheme: must be http or https")
	}

	for _, allowed := range allowedURLs {
		parsedAllowed, err := url.Parse(allowed)
		if err != nil {
			continue
		}

		if strings.EqualFold(parsedRedirect.Scheme, parsedAllowed.Scheme) &&
			strings.EqualFold(parsedRedirect.Host, parsedAllowed.Host) {
			return nil
		}
	}

	return fmt.Errorf("redirect URL not in allowlist")
}